<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>StatusMantra AI - Ultra HD Optimizer</title>
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
Â  Â  <script src="https://unpkg.com/lucide@latest"></script>
Â  Â Â 
Â  Â  <style>
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --color-primary: #06b6d4; /* Teal/Cyan */
Â  Â  Â  Â  Â  Â  --color-secondary: #db2777; /* Magenta/Pink */
Â  Â  Â  Â  Â  Â  --color-bg-dark: #1f2937; /* Dark Gray */
Â  Â  Â  Â  Â  Â  --color-text-light: #f3f4f6; /* Off White */
Â  Â  Â  Â  }
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  Â  Â  background-color: var(--color-bg-dark);
Â  Â  Â  Â  Â  Â  color: var(--color-text-light);
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  }
Â  Â  Â  Â  .app-header {
Â  Â  Â  Â  Â  Â  background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-secondary) 100%);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â  .card {
Â  Â  Â  Â  Â  Â  background-color: #2e3b4a; /* Slightly lighter than background for depth */
Â  Â  Â  Â  Â  Â  border-radius: 1.5rem;
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(255, 255, 255, 0.05);
Â  Â  Â  Â  }
Â  Â  Â  Â  .drop-zone {
Â  Â  Â  Â  Â  Â  border: 2px dashed var(--color-primary);
Â  Â  Â  Â  Â  Â  border-radius: 1rem;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  .drop-zone.drag-over {
Â  Â  Â  Â  Â  Â  background-color: rgba(6, 182, 212, 0.1);
Â  Â  Â  Â  Â  Â  border-color: var(--color-secondary);
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-primary {
Â  Â  Â  Â  Â  Â  background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-secondary) 100%);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 0.75rem 1.5rem;
Â  Â  Â  Â  Â  Â  border-radius: 0.75rem;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  transition: transform 0.2s, opacity 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-primary:hover:not(:disabled) {
Â  Â  Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 15px rgba(219, 39, 119, 0.5);
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-primary:disabled {
Â  Â  Â  Â  Â  Â  Â opacity: 0.5;
Â  Â  Â  Â  Â  Â  Â cursor: not-allowed;
Â  Â  Â  Â  }
Â  Â  Â  Â  .error-message {
Â  Â  Â  Â  Â  Â  background-color: #451b2f; /* Darkened error background */
Â  Â  Â  Â  Â  Â  color: #fca5a5; /* Light red text */
Â  Â  Â  Â  Â  Â  border: 1px solid #dc2626;
Â  Â  Â  Â  }
Â  Â  Â  Â  .info-message {
Â  Â  Â  Â  Â  Â  background-color: #1e3a8a; /* Dark blue info */
Â  Â  Â  Â  Â  Â  color: #93c5fd; /* Light blue text */
Â  Â  Â  Â  Â  Â  border: 1px solid #3b82f6;
Â  Â  Â  Â  }
Â  Â  Â  Â  .processing-bar {
Â  Â  Â  Â  Â  Â  background-color: #4b5563;
Â  Â  Â  Â  Â  Â  border-radius: 0.5rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  .progress-fill {
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
Â  Â  Â  Â  Â  Â  border-radius: 0.5rem;
Â  Â  Â  Â  Â  Â  transition: width 0.3s ease-in-out;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 10px rgba(6, 182, 212, 0.5);
Â  Â  Â  Â  }
Â  Â  Â  Â  .footer-bar {
Â  Â  Â  Â  Â  Â  background-color: #111827;
Â  Â  Â  Â  Â  Â  color: #6b7280;
Â  Â  Â  Â  }
Â  Â  Â  Â  .ai-result-card {
Â  Â  Â  Â  Â  Â  background-color: #111827;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--color-primary);
Â  Â  Â  Â  }
Â  Â  Â  Â  .input-dark {
Â  Â  Â  Â  Â  Â  background-color: #111827;
Â  Â  Â  Â  Â  Â  color: var(--color-text-light);
Â  Â  Â  Â  Â  Â  border: 1px solid #4b5563;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Custom Ad Container for better centering and responsiveness */
Â  Â  Â  Â  .ad-container {
Â  Â  Â  Â  Â  Â  margin: 2rem auto;
Â  Â  Â  Â  Â  Â  max-width: 468px;Â 
Â  Â  Â  Â  Â  Â  height: 60px;Â 
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* NEW: CSS for the Loading Spinner (used in AI Caption Generator) */
Â  Â  Â  Â  .loading-ring {
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  width: 20px;
Â  Â  Â  Â  Â  Â  height: 20px;
Â  Â  Â  Â  Â  Â  border: 3px solid #f3f4f6;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  border-top-color: var(--color-secondary);
Â  Â  Â  Â  Â  Â  animation: spin 1s ease-in-out infinite;
Â  Â  Â  Â  Â  Â  -webkit-animation: spin 1s ease-in-out infinite;
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes spin {
Â  Â  Â  Â  Â  Â  to { -webkit-transform: rotate(360deg); }
Â  Â  Â  Â  }
Â  Â  Â  Â  @-webkit-keyframes spin {
Â  Â  Â  Â  Â  Â  to { -webkit-transform: rotate(360deg); }
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body class="flex flex-col items-center">

Â  Â  <header class="app-header w-full shadow-2xl">
Â  Â  Â  Â  <div class="max-w-4xl mx-auto p-4 flex justify-between items-center">
Â  Â  Â  Â  Â  Â  <h1 class="text-3xl font-black tracking-widest">STATUS<span class="text-gray-200 font-light">MANTRA</span></h1>
Â  Â  Â  Â  Â  Â  <span class="text-sm font-light opacity-80">AI Optimized Media</span>
Â  Â  Â  Â  </div>
Â  Â  </header>

Â  Â  <main class="w-full max-w-4xl p-4 flex-grow">
Â  Â  Â  Â  <div id="app-container" class="card p-6 md:p-10 my-8 w-full space-y-8">

Â  Â  Â  Â  Â  Â  <h2 class="text-4xl font-extrabold text-center tracking-tighter">
Â  Â  Â  Â  Â  Â  Â  Â  One-Click <span class="app-header bg-clip-text text-transparent">AI Media Optimization</span>
Â  Â  Â  Â  Â  Â  </h2>

Â  Â  Â  Â  Â  Â  <div id="status-message-container" class="mb-6">
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="ad-container overflow-hidden">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-gray-500">Ad Placeholder (External script blocked)</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="upload-section">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-semibold mb-4 text-center text-gray-300">Upload File (Video or Image)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="drop-zone" class="drop-zone p-8 text-center cursor-pointer transition-all">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="video" class="w-12 h-12 text-teal-400 mx-auto mb-3"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-2xl font-bold mb-1 text-gray-100">Drop Video or Image Here</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-400">or click to select file (Max size 100MB recommended)</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="file-input" class="hidden" accept="video/*,image/*" capture="filesystem">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="processing-section" class="hidden mt-8">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-semibold mb-4 text-center text-gray-300">2. Processing Media...</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="processing-bar w-full h-8 mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="progress-fill" class="progress-fill text-xs text-white flex justify-center items-center font-bold" style="width: 0%">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  0%
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="processing-status" class="text-center text-sm text-gray-400">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Initializing compression pipeline...
Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="results-section" class="hidden mt-8 space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-semibold text-center text-teal-400">3. Optimization Complete!</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-center text-gray-400">Your optimized segments are ready for download.</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div id="ai-caption-section" class="mt-8 pt-6 border-t border-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-semibold mb-4 text-center text-gray-300 flex items-center justify-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="sparkles" class="w-5 h-5 text-yellow-400 mr-2"></i>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  AI Caption Generator
Â  Â  Â  Â  Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-center text-sm text-gray-400 mb-4">Generate catchy captions for your optimized content using Gemini AI.</p>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="ai-prompt-input" rows="3" class="w-full p-3 rounded-lg input-dark focus:ring-2 focus:ring-cyan-500 resize-none" placeholder="Describe your video/image content (e.g., 'A cat jumping into a box in slow motion')"></textarea>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col sm:flex-row gap-4 mt-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="generate-caption-button" class="btn-primary flex-1 flex items-center justify-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="caption-spinner" class="hidden loading-ring mr-2"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="magic-wand" class="w-5 h-5 mr-2" id="magic-wand-icon"></i>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Generate 3 Status Captions
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="clear-captions-button" class="btn-primary flex-1 opacity-70 hover:opacity-100 transition duration-200" style="background: #374151;" >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Clear Results
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="ai-results" class="mt-6 space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="ad-container overflow-hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â <p class="text-xs text-gray-500">Ad Placeholder (External script blocked)</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="mt-6 text-center">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="upload-button" class="btn-primary w-full max-w-xs" onclick="document.getElementById('file-input').click()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Select File
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  </div>
Â  Â  </main>

Â  Â  <footer class="footer-bar w-full p-3 text-center text-sm mt-auto">
Â  Â  Â  Â  &copy; 2024 NancySocialSolutions. All rights reserved.
Â  Â  </footer>

Â  Â  <script type="module">
Â  Â  Â  Â  // --- Configuration ---
Â  Â  Â  Â  // ðŸš¨ CRITICAL FIX APPLIED: Using the confirmed, working Cloud Run URL in the asia-south1 region.
Â  Â  Â  Â  const OPTIMIZER_API_URL = 'https://status-optimizer-service-420017097259.asia-south1.run.app';Â 
Â  Â  Â  Â  const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=';
Â  Â  Â  Â  // ðŸš¨ CRITICAL: Replace this with your actual Gemini API Key to enable captions.
Â  Â  Â  Â  const API_KEY = "YOUR_GEMINI_API_KEY_HERE";Â 
Â  Â  Â  Â  // ðŸš¨ INCREASED: Upload timeout increased to 60 seconds for mobile networks.
Â  Â  Â  Â  const UPLOAD_TIMEOUT_MS = 60000;Â 
Â  Â  Â  Â  const TOTAL_PROCESS_TIMEOUT_MS = 300000; // 5 minutes for total processing

Â  Â  Â  Â  // --- UI Elements ---
Â  Â  Â  Â  const dropZone = document.getElementById('drop-zone');
Â  Â  Â  Â  const fileInput = document.getElementById('file-input');
Â  Â  Â  Â  const uploadButton = document.getElementById('upload-button');
Â  Â  Â  Â  const uploadSection = document.getElementById('upload-section');
Â  Â  Â  Â  const processingSection = document.getElementById('processing-section');
Â  Â  Â  Â  const resultsSection = document.getElementById('results-section');
Â  Â  Â  Â  const progressFill = document.getElementById('progress-fill');
Â  Â  Â  Â  const processingStatus = document.getElementById('processing-status');
Â  Â  Â  Â  const statusContainer = document.getElementById('status-message-container');
Â  Â  Â  Â Â 
Â  Â  Â  Â  // AI Elements
Â  Â  Â  Â  const aiPromptInput = document.getElementById('ai-prompt-input');
Â  Â  Â  Â  const generateCaptionButton = document.getElementById('generate-caption-button');
Â  Â  Â  Â  const aiResultsContainer = document.getElementById('ai-results');
Â  Â  Â  Â  const captionSpinner = document.getElementById('caption-spinner');
Â  Â  Â  Â  const magicWandIcon = document.getElementById('magic-wand-icon');
Â  Â  Â  Â  const clearCaptionsButton = document.getElementById('clear-captions-button');Â 

Â  Â  Â  Â  // Initialize icons
Â  Â  Â  Â  lucide.createIcons();

Â  Â  Â  Â  // --- State Management ---
Â  Â  Â  Â  let isProcessing = false;
Â  Â  Â  Â  let isGeneratingAI = false;

Â  Â  Â  Â  // --- Utility Functions ---

Â  Â  Â  Â  const formatFileSize = (bytes) => {
Â  Â  Â  Â  Â  Â  if (bytes === 0) return '0 Bytes';
Â  Â  Â  Â  Â  Â  const megabytes = bytes / (1024 * 1024);
Â  Â  Â  Â  Â  Â  return `${megabytes.toFixed(2)} MB`;
Â  Â  Â  Â  };

Â  Â  Â  Â  const showStatusMessage = (message, type = 'info') => {
Â  Â  Â  Â  Â  Â  statusContainer.innerHTML = '';Â 
Â  Â  Â  Â  Â  Â  const messageDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  messageDiv.classList.add('text-center', 'font-semibold', 'p-4', 'rounded-xl', 'mb-4', 'shadow-lg');

Â  Â  Â  Â  Â  Â  if (type === 'error') {
Â  Â  Â  Â  Â  Â  Â  Â  messageDiv.classList.add('error-message');
Â  Â  Â  Â  Â  Â  Â  Â  messageDiv.innerHTML = `<p><span class="inline-flex items-center"><i data-lucide="alert-triangle" class="w-5 h-5 inline mr-2 text-red-400"></i> **Error:** ${message}</span></p>`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  messageDiv.classList.add('info-message');
Â  Â  Â  Â  Â  Â  Â  Â  messageDiv.innerHTML = `<p><span class="inline-flex items-center"><i data-lucide="info" class="w-5 h-5 inline mr-2 text-blue-400"></i> ${message}</span></p>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  statusContainer.appendChild(messageDiv);
Â  Â  Â  Â  Â  Â  lucide.createIcons();
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  const renderDownloadCard = (segment, index) => {
Â  Â  Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  Â  Â  card.classList.add('card', 'p-4', 'flex', 'flex-col', 'md:flex-row', 'items-center', 'justify-between', 'border', 'border-cyan-500', 'shadow-xl');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const isPlaceholder = segment.url === '#';
Â  Â  Â  Â  Â  Â  const fileTitle = segment.fileName || `Optimized_Segment_${index + 1}.mp4`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4 md:mb-0 md:mr-6 text-center md:text-left">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-gray-100 break-words">${fileTitle}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-400">Size: ${formatFileSize(segment.size)}</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="${segment.url}" download="${fileTitle}" class="btn-primary text-center w-full md:w-auto mt-2 md:mt-0 ${isPlaceholder ? 'opacity-50 cursor-not-allowed' : ''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="download" class="w-4 h-4 inline mr-2"></i> Download File
Â  Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  resultsSection.appendChild(card);
Â  Â  Â  Â  Â  Â  lucide.createIcons();
Â  Â  Â  Â  };

Â  Â  Â  Â  const updateProgress = (percent, statusText) => {
Â  Â  Â  Â  Â  Â  const width = Math.min(100, Math.max(0, percent));
Â  Â  Â  Â  Â  Â  progressFill.style.width = `${width}%`;
Â  Â  Â  Â  Â  Â  progressFill.textContent = `${Math.round(width)}%`;
Â  Â  Â  Â  Â  Â  processingStatus.textContent = statusText;
Â  Â  Â  Â  };

Â  Â  Â  Â  const setUIMode = (showSectionId) => {
Â  Â  Â  Â  Â  Â  uploadSection.classList.add('hidden');
Â  Â  Â  Â  Â  Â  processingSection.classList.add('hidden');
Â  Â  Â  Â  Â  Â  resultsSection.classList.add('hidden');
Â  Â  Â  Â  Â  Â  uploadButton.classList.add('hidden');
Â  Â  Â  Â  Â  Â  statusContainer.innerHTML = '';Â 

Â  Â  Â  Â  Â  Â  if (showSectionId === 'upload') {
Â  Â  Â  Â  Â  Â  Â  Â  uploadSection.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  uploadButton.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  resultsSection.innerHTML = '<h3 class="text-xl font-semibold text-center text-teal-400">3. Optimization Complete!</h3><p class="text-center text-gray-400">Your optimized segments are ready for download.</p>';
Â  Â  Â  Â  Â  Â  } else if (showSectionId === 'processing') {
Â  Â  Â  Â  Â  Â  Â  Â  processingSection.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  } else if (showSectionId === 'results') {
Â  Â  Â  Â  Â  Â  Â  Â  resultsSection.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  uploadButton.classList.remove('hidden');Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- Core Logic (Video/Image Optimization) ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  /** Uploads file using XMLHttpRequest for progress tracking and returns a Promise. */
Â  Â  Â  Â  const uploadFileWithProgress = (file) => {
Â  Â  Â  Â  Â  Â  return new Promise((resolve, reject) => {
Â  Â  Â  Â  Â  Â  Â  Â  const xhr = new XMLHttpRequest();
Â  Â  Â  Â  Â  Â  Â  Â  const formData = new FormData();
Â  Â  Â  Â  Â  Â  Â  Â  formData.append('file', file);

Â  Â  Â  Â  Â  Â  Â  Â  // ðŸš¨ CRITICAL FIX APPLIED: Changed /upload to /optimize
Â  Â  Â  Â  Â  Â  Â  Â  xhr.open('POST', `${OPTIMIZER_API_URL}/optimize`);
Â  Â  Â  Â  Â  Â  Â  Â  xhr.timeout = UPLOAD_TIMEOUT_MS;

Â  Â  Â  Â  Â  Â  Â  Â  xhr.upload.addEventListener('progress', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (e.lengthComputable) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const percent = (e.loaded / e.total) * 20; // 0% to 20% is upload
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateProgress(percent, `Uploading ${file.name} (${formatFileSize(e.total)})...`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  xhr.onload = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (xhr.status >= 200 && xhr.status < 300) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve(JSON.parse(xhr.responseText));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reject(new Error("Server returned an invalid JSON response after upload."));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Attempt to parse server error response if available
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let errorDetail = xhr.responseText.substring(0, 300); // Increased error detail size
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (errorDetail.includes('<') || errorDetail.includes('>')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â errorDetail = "No detailed server error message available. (Check Cloud Run Logs for more details)";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reject(new Error(`Upload failed. HTTP Status: ${xhr.status}. Server response snippet: ${errorDetail}`));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  xhr.ontimeout = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reject(new Error(`Upload timed out after ${UPLOAD_TIMEOUT_MS / 1000} seconds. Your internet connection may be slow or the server might be overloaded. Please try again.`));
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  xhr.onerror = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reject(new Error("Network error occurred during upload. Check your connection or CORS/firewall configuration on the server."));
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  xhr.send(formData);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };


Â  Â  Â  Â  /** Handles the file upload and initiates the compression process. */
Â  Â  Â  Â  const startCompression = async (file) => {
Â  Â  Â  Â  Â  Â  if (isProcessing) return;
Â  Â  Â  Â  Â  Â  isProcessing = true;
Â  Â  Â  Â  Â  Â  setUIMode('processing');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  resultsSection.innerHTML = '<h3 class="text-xl font-semibold text-center text-teal-400">3. Optimization Complete!</h3><p class="text-center text-gray-400">Your optimized segments are ready for download.</p>';

Â  Â  Â  Â  Â  Â  if (file.type.startsWith('image/')) {
Â  Â  Â  Â  Â  Â  Â  Â  showStatusMessage('Image detected! Performing fast client-side optimization.', 'info');
Â  Â  Â  Â  Â  Â  Â  Â  updateProgress(10, 'Processing image locally...');
Â  Â  Â  Â  Â  Â  Â  Â  await processImageClientSide(file);
Â  Â  Â  Â  Â  Â  Â  Â  isProcessing = false;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  } else if (!file.type.startsWith('video/')) {
Â  Â  Â  Â  Â  Â  Â  Â  showStatusMessage('Unsupported file type. Please upload a video or image file.', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  setUIMode('upload');
Â  Â  Â  Â  Â  Â  Â  Â  isProcessing = false;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- Video Processing (Server-Side via Cloud Run API) ---
Â  Â  Â  Â  Â  Â  showStatusMessage('Video file detected. Using deployed Cloud Run API for processing...', 'info');

Â  Â  Â  Â  Â  Â  let timeoutId;
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Set overall processing timeout
Â  Â  Â  Â  Â  Â  Â  Â  const overallProcessTimeout = new Promise((_, reject) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timeoutId = setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reject(new Error(`Total processing timed out after ${TOTAL_PROCESS_TIMEOUT_MS / 60000} minutes. The server is taking too long.`));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, TOTAL_PROCESS_TIMEOUT_MS);
Â  Â  Â  Â  Â  Â  Â  Â  });


Â  Â  Â  Â  Â  Â  Â  Â  // 1. UPLOAD STAGE (Using XHR for progress)
Â  Â  Â  Â  Â  Â  Â  Â  const uploadPromise = uploadFileWithProgress(file);
Â  Â  Â  Â  Â  Â  Â  Â  // Use Promise.race to enforce upload timeout
Â  Â  Â  Â  Â  Â  Â  Â  const uploadData = await Promise.race([uploadPromise, overallProcessTimeout]);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // If upload is successful, clear the overall process timeout, and reset it later
Â  Â  Â  Â  Â  Â  Â  Â  clearTimeout(timeoutId);Â 

Â  Â  Â  Â  Â  Â  Â  Â  const fileId = uploadData.fileId;
Â  Â  Â  Â  Â  Â  Â  Â  updateProgress(20, `File uploaded successfully. Starting server-side FFmpeg compression...`);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 2. PROCESS STAGE
Â  Â  Â  Â  Â  Â  Â  Â  // NOTE: We assume /process is the next endpoint, if the backend uses a different flow, this needs adjustment.
Â  Â  Â  Â  Â  Â  Â  Â  const processResponse = await fetch(`${OPTIMIZER_API_URL}/process`, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ fileId: fileId })
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  if (!processResponse.ok) {Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const errorText = await processResponse.text().catch(() => 'No response body.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â throw new Error(`Processing initiation failed. Status: ${processResponse.status}. Details: ${errorText.substring(0, 100)}`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const processData = await processResponse.json();
Â  Â  Â  Â  Â  Â  Â  Â  const jobId = processData.jobId;
Â  Â  Â  Â  Â  Â  Â  Â  updateProgress(40, `Compression job started (ID: ${jobId}). Waiting for results...`);

Â  Â  Â  Â  Â  Â  Â  Â  // 3. POLLING STAGE (Wait for job to complete)
Â  Â  Â  Â  Â  Â  Â  Â  let jobComplete = false;
Â  Â  Â  Â  Â  Â  Â  Â  let finalResult = null;
Â  Â  Â  Â  Â  Â  Â  Â  const pollInterval = 5000;Â 
Â  Â  Â  Â  Â  Â  Â  Â  let attempts = 0;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Re-establish overall process timeout for polling stage
Â  Â  Â  Â  Â  Â  Â  Â  const pollingTimeoutId = setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("Job polling timed out. The server took too long to respond.");
Â  Â  Â  Â  Â  Â  Â  Â  }, TOTAL_PROCESS_TIMEOUT_MS);

Â  Â  Â  Â  Â  Â  Â  Â  const pollingPromise = new Promise(async (resolve, reject) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  while (!jobComplete && attempts < (TOTAL_PROCESS_TIMEOUT_MS / pollInterval)) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  attempts++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(r => setTimeout(r, pollInterval));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const statusResponse = await fetch(`${OPTIMIZER_API_URL}/status?jobId=${jobId}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!statusResponse.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Status check failed. Retrying...");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateProgress(40 + (attempts * 0.9), `Server Status Check Failed (Attempt ${attempts}). Retrying...`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const statusData = await statusResponse.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (statusData.status === 'completed') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  jobComplete = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  finalResult = statusData;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (statusData.status === 'failed') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reject(new Error(`Video processing failed on the server. Details: ${statusData.error || 'Unknown error.'}`));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const progress = Math.min(95, 40 + (attempts * 0.9));Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateProgress(progress, `Optimization in progress... (Attempt ${attempts})`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // This case is theoretically covered by pollingTimeoutId, but good for completeness
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!jobComplete) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â reject(new Error("Job polling loop finished without completion. Timeout occurred or internal error."));Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  await pollingPromise;
Â  Â  Â  Â  Â  Â  Â  Â  clearTimeout(pollingTimeoutId);Â 

Â  Â  Â  Â  Â  Â  Â  Â  updateProgress(100, 'All segments successfully optimized!');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 4. DISPLAY RESULTS
Â  Â  Â  Â  Â  Â  Â  Â  if (finalResult && finalResult.segments && finalResult.segments.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showStatusMessage(`Success! Video split into ${finalResult.segments.length} optimized 30-second segments.`, 'info');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  finalResult.segments.forEach(renderDownloadCard);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setUIMode('results');
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("Server completed the job but returned no downloadable segments. Check video length or server logs.");
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  // Clear any remaining timeouts
Â  Â  Â  Â  Â  Â  Â  Â  clearTimeout(timeoutId);Â 
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Compression Error:", error);
Â  Â  Â  Â  Â  Â  Â  Â  updateProgress(0, 'Failed.');Â 
Â  Â  Â  Â  Â  Â  Â  Â  showStatusMessage(error.message || "An unknown error occurred during video compression. Check if the Cloud Run service is active and publicly accessible.", 'error');
Â  Â  Â  Â  Â  Â  Â  Â  setUIMode('upload');
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  isProcessing = false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  /** Processes images locally using the Canvas API for compression. */
Â  Â  Â  Â  const processImageClientSide = (file) => {
Â  Â  Â  Â  Â  Â  return new Promise((resolve) => {
Â  Â  Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  Â  Â  reader.onload = (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const img = new Image();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  img.onload = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const canvas = document.createElement('canvas');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const ctx = canvas.getContext('2d');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateProgress(30, 'Resizing image...');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const maxWidth = 1920;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const maxHeight = 1080;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let width = img.width;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let height = img.height;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (width > height) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (width > maxWidth) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  height *= maxWidth / width;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  width = maxWidth;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (height > maxHeight) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  width *= maxHeight / height;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  height = maxHeight;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  canvas.width = width;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  canvas.height = height;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.drawImage(img, 0, 0, width, height);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateProgress(60, 'Applying JPEG compression...');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Compress using JPEG at 80% quality
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  canvas.toBlob((blob) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!blob) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showStatusMessage("Could not compress image.", 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setUIMode('upload');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return resolve();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const originalSize = file.size;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const compressedSize = blob.size;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // This URL (blob URL) is the actual local download link for images.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const compressedUrl = URL.createObjectURL(blob);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setUIMode('results');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showStatusMessage(`Image optimization complete! Original Size: ${formatFileSize(originalSize)} | New Size: ${formatFileSize(compressedSize)}`, 'info');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const segment = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fileName: `optimized_${file.name.replace(/\.[^/.]+$/, "")}.jpg`,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  size: compressedSize,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  url: compressedUrl
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderDownloadCard(segment, 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateProgress(100, 'Image optimization complete!');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 'image/jpeg', 0.8);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Image Processing Error:", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showStatusMessage("Error processing image in browser.", 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setUIMode('upload');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  img.src = event.target.result;
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  reader.onerror = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showStatusMessage("Error reading file.", 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setUIMode('upload');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve();
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  reader.readAsDataURL(file);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- AI Caption Generator Logic (Unchanged) ---

Â  Â  Â  Â  const generateAICaptions = async () => {
Â  Â  Â  Â  Â  Â  if (isGeneratingAI) return;
Â  Â  Â  Â  Â  Â  const userPrompt = aiPromptInput.value.trim();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (API_KEY === "YOUR_GEMINI_API_KEY_HERE" || !API_KEY) {
Â  Â  Â  Â  Â  Â  Â  Â  showStatusMessage("CRITICAL: Please replace 'YOUR_GEMINI_API_KEY_HERE' in the code with a valid Gemini API Key to use the AI Caption Generator.", 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (!userPrompt) {
Â  Â  Â  Â  Â  Â  Â  Â  showStatusMessage("Please describe your video/image content before generating captions.", 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  isGeneratingAI = true;
Â  Â  Â  Â  Â  Â  aiResultsContainer.innerHTML = '';
Â  Â  Â  Â  Â  Â  captionSpinner.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  magicWandIcon.classList.add('hidden');
Â  Â  Â  Â  Â  Â  generateCaptionButton.disabled = true;

Â  Â  Â  Â  Â  Â  const systemPrompt = "You are a creative social media manager specializing in short, viral video captions. Your task is to generate three unique, catchy, and status-ready captions based on the user's content description. Each caption must be distinct and ready to be used on platforms like WhatsApp or Instagram Stories. Format your final output as a numbered list.";
Â  Â  Â  Â  Â  Â  const userQuery = `Generate 3 captions for content described as: "${userPrompt}"`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  Â  Â  Â  contents: [{ parts: [{ text: userQuery }] }],
Â  Â  Â  Â  Â  Â  Â  Â  config: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  systemInstruction: systemPrompt
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  let responseText = "Failed to generate captions.";
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < 3; i++) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(GEMINI_API_URL + API_KEY, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  responseText = result.candidates?.[0]?.content?.parts?.[0]?.text || "No response received from AI model.";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (i < 2) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`API call failed with status ${response.status} (Check API Key validity).`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Gemini API Error:", error);
Â  Â  Â  Â  Â  Â  Â  Â  responseText = "Sorry, the AI caption generator failed to connect or process your request. Please ensure your Gemini API Key is correct and try again later.";
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  captionSpinner.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  magicWandIcon.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  generateCaptionButton.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  isGeneratingAI = false;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const captions = responseText.split('\n').filter(line => line.trim().length > 0);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (captions.length > 0 && captions[0] !== "Failed to generate captions.") {
Â  Â  Â  Â  Â  Â  Â  Â  captions.forEach((caption, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const captionDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  captionDiv.classList.add('ai-result-card', 'p-3', 'rounded-lg', 'text-gray-200', 'text-sm', 'break-words', 'flex', 'items-center', 'justify-between');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cleanedCaption = caption.replace(/^\d+\.\s*/, '');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  captionDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="mr-2 font-bold text-cyan-400">${index + 1}.</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="flex-1">${cleanedCaption}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="copy-btn ml-4 text-pink-400 hover:text-pink-300 transition duration-150" data-caption="${cleanedCaption.replace(/"/g, '&quot;')}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="copy" class="w-4 h-4"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aiResultsContainer.appendChild(captionDiv);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lucide.createIcons();
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Add Copy Button Listeners
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.copy-btn').forEach(button => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  button.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const captionToCopy = e.currentTarget.dataset.caption;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  navigator.clipboard.writeText(captionToCopy)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Show temporary confirmation on the button itself
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const originalIcon = e.currentTarget.innerHTML;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.currentTarget.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-green-400"></i>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lucide.createIcons();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.currentTarget.innerHTML = originalIcon;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lucide.createIcons();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 1500);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .catch(err => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Could not copy text: ', err);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  showStatusMessage(responseText, 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  const clearAICaptions = () => {
Â  Â  Â  Â  Â  Â  aiResultsContainer.innerHTML = '';
Â  Â  Â  Â  Â  Â  aiPromptInput.value = '';
Â  Â  Â  Â  Â  Â  statusContainer.innerHTML = ''; // Clear main status messages too
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- Event Listeners ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Drop Zone functionality
Â  Â  Â  Â  dropZone.addEventListener('click', () => fileInput.click());
Â  Â  Â  Â  dropZone.addEventListener('dragover', (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  dropZone.classList.add('drag-over');
Â  Â  Â  Â  });
Â  Â  Â  Â  dropZone.addEventListener('dragleave', () => {
Â  Â  Â  Â  Â  Â  dropZone.classList.remove('drag-over');
Â  Â  Â  Â  });
Â  Â  Â  Â  dropZone.addEventListener('drop', (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  dropZone.classList.remove('drag-over');
Â  Â  Â  Â  Â  Â  if (e.dataTransfer.files.length) {
Â  Â  Â  Â  Â  Â  Â  Â  const file = e.dataTransfer.files[0];
Â  Â  Â  Â  Â  Â  Â  Â  startCompression(file);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // File Input change
Â  Â  Â  Â  fileInput.addEventListener('change', (e) => {
Â  Â  Â  Â  Â  Â  if (e.target.files.length) {
Â  Â  Â  Â  Â  Â  Â  Â  startCompression(e.target.files[0]);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // AI Button Listeners
Â  Â  Â  Â  generateCaptionButton.addEventListener('click', generateAICaptions);
Â  Â  Â  Â  clearCaptionsButton.addEventListener('click', clearAICaptions);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Initialize UI
Â  Â  Â  Â  setUIMode('upload');
Â  Â  Â  Â  showStatusMessage('Ready to optimize your media. Select a file to begin.', 'info');

Â  Â  </script>

</body>
</html>
