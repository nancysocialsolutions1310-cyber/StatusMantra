<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StatusMantra AI - Ultra HD Optimizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <!-- Lucide Icons for video/camera -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --color-primary: #06b6d4; /* Teal/Cyan */
            --color-secondary: #db2777; /* Magenta/Pink */
            --color-bg-dark: #1f2937; /* Dark Gray */
            --color-text-light: #f3f4f6; /* Off White */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg-dark);
            color: var(--color-text-light);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .app-header {
            background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            color: white;
        }
        .card {
            background-color: #2e3b4a; /* Slightly lighter than background for depth */
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .drop-zone {
            border: 2px dashed var(--color-primary);
            border-radius: 1rem;
            transition: all 0.3s ease;
        }
        .drop-zone.drag-over {
            background-color: rgba(6, 182, 212, 0.1);
            border-color: var(--color-secondary);
        }
        .btn-primary {
            background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 700;
            transition: transform 0.2s, opacity 0.2s;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(219, 39, 119, 0.5);
        }
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .error-message {
            background-color: #451b2f; /* Darkened error background */
            color: #fca5a5; /* Light red text */
            border: 1px solid #dc2626;
        }
        .info-message {
            background-color: #1e3a8a; /* Dark blue info */
            color: #93c5fd; /* Light blue text */
            border: 1px solid #3b82f6;
        }
        .processing-bar {
            background-color: #4b5563;
            border-radius: 0.5rem;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
            border-radius: 0.5rem;
            transition: width 0.3s ease-in-out;
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.5);
        }
        .footer-bar {
            background-color: #111827;
            color: #6b7280;
        }
        .ai-result-card {
            background-color: #111827;
            border: 1px solid var(--color-primary);
        }
        .input-dark {
            background-color: #111827;
            color: var(--color-text-light);
            border: 1px solid #4b5563;
        }
        
        /* Custom Ad Container for better centering and responsiveness */
        .ad-container {
            margin: 1.5rem auto; /* Adjusted margin for mobile */
            max-width: 468px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        /* Custom Spinner Style */
        .loading-ring {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex flex-col items-center">

    <!-- Header -->
    <header class="app-header w-full shadow-2xl">
        <div class="max-w-4xl mx-auto p-4 flex justify-between items-center">
            <!-- Adjusted font size for mobile -->
            <h1 class="text-xl sm:text-3xl font-black tracking-widest">STATUS<span class="text-gray-200 font-light">MANTRA</span></h1>
            <span class="text-xs sm:text-sm font-light opacity-80">AI Optimized Media</span>
        </div>
    </header>

    <!-- Main Content -->
    <main class="w-full max-w-4xl p-2 sm:p-4 flex-grow">
        <!-- Reduced p-6 md:p-10 to p-4 md:p-10 on the card for better mobile spacing -->
        <div id="app-container" class="card p-4 md:p-10 my-4 sm:my-8 w-full space-y-8">

            <!-- Adjusted H2 font size for mobile -->
            <h2 class="text-3xl sm:text-4xl font-extrabold text-center tracking-tighter">
                One-Click <span class="app-header bg-clip-text text-transparent">AI Media Optimization</span>
            </h2>

            <!-- Status Messages -->
            <div id="status-message-container" class="mb-4">
                <!-- Status Messages / Error messages will appear here -->
            </div>

            <!-- ******************************************************************* -->
            <!-- 1. ADVERTISEMENT SLOT - HEADER BANNER -->
            <div class="ad-container overflow-hidden">
                <script type="text/javascript">
                    atOptions = {
                        'key' : '16a502080d5a846fc5b18c305ec9b6b7',
                        'format' : 'iframe',
                        'height' : 60,
                        'width' : 468,
                        'params' : {}
                    };
                </script>
                <script type="text/javascript" src="//www.highperformanceformat.com/16a502080d5a846fc5b18c305ec9b6b7/invoke.js"></script>
            </div>
            <!-- ******************************************************************* -->

            <!-- UPLOAD SECTION -->
            <div id="upload-section">
                <h3 class="text-lg sm:text-xl font-semibold mb-4 text-center text-gray-300">Upload File</h3>
                <!-- Adjusted padding in drop zone for mobile (p-6) -->
                <div id="drop-zone" class="drop-zone p-6 text-center cursor-pointer transition-all">
                    <i data-lucide="video" class="w-10 h-10 sm:w-12 sm:h-12 text-teal-400 mx-auto mb-3"></i>
                    <p class="text-xl sm:text-2xl font-bold mb-1 text-gray-100">Drop Video or Image Here</p>
                    <p class="text-gray-400 text-sm sm:text-base">or click to select file (Max size 100MB recommended)</p>
                    <input type="file" id="file-input" class="hidden" accept="video/*,image/*">
                </div>
            </div>

            <!-- PROCESSING SECTION -->
            <div id="processing-section" class="hidden mt-8">
                <h3 class="text-lg sm:text-xl font-semibold mb-4 text-center text-gray-300">2. Processing Media...</h3>
                <div class="processing-bar w-full h-8 mb-4">
                    <div id="progress-fill" class="progress-fill text-xs text-white flex justify-center items-center font-bold" style="width: 0%">
                        0%
                    </div>
                </div>
                <p id="processing-status" class="text-center text-sm text-gray-400">
                    Initializing compression pipeline...
                </p>
            </div>

            <!-- RESULTS SECTION -->
            <div id="results-section" class="hidden mt-8 space-y-4">
                <h3 class="text-xl font-semibold text-center text-teal-400">3. Optimization Complete!</h3>
                <p class="text-center text-gray-400">Your optimized segments are ready for download.</p>
                <!-- Download cards will be inserted here -->
            </div>
            
            <!-- AI CAPTION GENERATOR SECTION -->
            <div id="ai-caption-section" class="mt-8 pt-6 border-t border-gray-700">
                <h3 class="text-lg sm:text-xl font-semibold mb-4 text-center text-gray-300 flex items-center justify-center">
                    <i data-lucide="sparkles" class="w-5 h-5 text-yellow-400 mr-2"></i> 
                    AI Caption Generator
                </h3>
                <p class="text-center text-sm text-gray-400 mb-4">Generate catchy captions for your optimized content using Gemini AI.</p>
                
                <textarea id="ai-prompt-input" rows="3" class="w-full p-3 rounded-lg input-dark focus:ring-2 focus:ring-cyan-500 resize-none" placeholder="Describe your video/image content (e.g., 'A cat jumping into a box in slow motion')"></textarea>

                <!-- Button group stacking on mobile (default flex-col) and side-by-side on sm screens and up -->
                <div class="flex flex-col sm:flex-row gap-4 mt-4">
                    <button id="generate-caption-button" class="btn-primary flex-1 flex items-center justify-center">
                        <span id="caption-spinner" class="hidden loading-ring mr-2"></span>
                        <i data-lucide="magic-wand" class="w-5 h-5 mr-2" id="magic-wand-icon"></i> 
                        Generate 3 Status Captions
                    </button>
                    <button id="clear-captions-button" class="btn-primary flex-1 opacity-70 hover:opacity-100 transition duration-200" style="background: #374151;" onclick="document.getElementById('ai-results').innerHTML = ''">
                        Clear Results
                    </button>
                </div>

                <div id="ai-results" class="mt-6 space-y-3">
                    <!-- AI generated captions will appear here -->
                </div>
            </div>

            <!-- ******************************************************************* -->
            <!-- 2. ADVERTISEMENT SLOT - FOOTER BANNER -->
            <div class="ad-container overflow-hidden">
                <script type="text/javascript">
                    atOptions = {
                        'key' : '16a502080d5a846fc5b18c305ec9b6b7',
                        'format' : 'iframe',
                        'height' : 60,
                        'width' : 468,
                        'params' : {}
                    };
                </script>
                <script type="text/javascript" src="//www.highperformanceformat.com/16a502080d5a846fc5b18c305ec9b6b7/invoke.js"></script>
            </div>
            <!-- ******************************************************************* -->

            <!-- Upload Button (for mobile interaction, always visible under the content) -->
            <div class="mt-6 text-center">
                <!-- Ensure this button is responsive and visible for touch interaction -->
                <button id="upload-button" class="btn-primary w-full max-w-xs" onclick="document.getElementById('file-input').click()">
                    Select File
                </button>
            </div>
            
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer-bar w-full p-3 text-center text-sm mt-auto">
        &copy; 2024 NancySocialSolutions. All rights reserved.
    </footer>

    <script type="module">
        // --- Configuration ---
        const OPTIMIZER_API_URL = 'https://status-optimizer-service-420017097259.us-central1.run.app';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=';
        const API_KEY = ""; // Placeholder API Key

        // --- UI Elements ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const uploadButton = document.getElementById('upload-button');
        const uploadSection = document.getElementById('upload-section');
        const processingSection = document.getElementById('processing-section');
        const resultsSection = document.getElementById('results-section');
        const progressFill = document.getElementById('progress-fill');
        const processingStatus = document.getElementById('processing-status');
        const statusContainer = document.getElementById('status-message-container');
        
        // AI Elements
        const aiPromptInput = document.getElementById('ai-prompt-input');
        const generateCaptionButton = document.getElementById('generate-caption-button');
        const aiResultsContainer = document.getElementById('ai-results');
        const captionSpinner = document.getElementById('caption-spinner');
        const magicWandIcon = document.getElementById('magic-wand-icon');

        // Initialize icons
        lucide.createIcons();

        // --- State Management ---
        let isProcessing = false;
        let isGeneratingAI = false;

        // --- Utility Functions ---

        /** Converts file size in bytes to a human-readable string (MB). */
        const formatFileSize = (bytes) => {
            if (bytes === 0) return '0 Bytes';
            const megabytes = bytes / (1024 * 1024);
            return `${megabytes.toFixed(2)} MB`;
        };

        /** * Displays a temporary status message (error or info).
         * @param {string} message - The message content.
         * @param {string} type - 'error' or 'info'.
         */
        const showStatusMessage = (message, type = 'info') => {
            statusContainer.innerHTML = ''; 
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('text-center', 'font-semibold', 'p-4', 'rounded-xl', 'mb-4', 'shadow-lg', 'text-sm');

            if (type === 'error') {
                messageDiv.classList.add('error-message');
                messageDiv.innerHTML = `<p><i data-lucide="alert-triangle" class="w-5 h-5 inline mr-2 text-red-400"></i> **Error:** ${message}</p>`;
            } else {
                messageDiv.classList.add('info-message');
                messageDiv.innerHTML = `<p><i data-lucide="info" class="w-5 h-5 inline mr-2 text-blue-400"></i> ${message}</p>`;
            }
            statusContainer.appendChild(messageDiv);
            lucide.createIcons();
        };
        
        /** Renders the download card for a processed segment. */
        const renderDownloadCard = (segment, index) => {
            const card = document.createElement('div');
            card.classList.add('card', 'p-4', 'flex', 'flex-col', 'md:flex-row', 'items-center', 'justify-between', 'border', 'border-cyan-500', 'shadow-xl');
            
            const fileTitle = segment.fileName || `Optimized_Segment_${index + 1}.mp4`;
            
            card.innerHTML = `
                <div class="mb-4 md:mb-0 md:mr-6 text-center md:text-left">
                    <p class="font-bold text-gray-100 break-words">${fileTitle}</p>
                    <p class="text-sm text-gray-400">Size: ${formatFileSize(segment.size)}</p>
                </div>
                <a href="${segment.url}" download="${fileTitle}" class="btn-primary text-center w-full md:w-auto mt-2 md:mt-0">
                    <i data-lucide="download" class="w-4 h-4 inline mr-2"></i> Download File
                </a>
            `;
            resultsSection.appendChild(card);
            lucide.createIcons();
        };

        /** Updates the processing progress UI. */
        const updateProgress = (percent, statusText) => {
            const width = Math.min(100, Math.max(0, percent));
            progressFill.style.width = `${width}%`;
            progressFill.textContent = `${Math.round(width)}%`;
            processingStatus.textContent = statusText;
        };

        /** Hides all main sections except the specified one. */
        const setUIMode = (showSectionId) => {
            uploadSection.classList.add('hidden');
            processingSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            uploadButton.classList.add('hidden');
            statusContainer.innerHTML = '';

            if (showSectionId === 'upload') {
                uploadSection.classList.remove('hidden');
                uploadButton.classList.remove('hidden');
            } else if (showSectionId === 'processing') {
                processingSection.classList.remove('hidden');
            } else if (showSectionId === 'results') {
                resultsSection.classList.remove('hidden');
                uploadButton.classList.remove('hidden'); // Keep upload button visible to start a new job
            }
        };

        // --- Core Logic (Video/Image Optimization) ---

        /** Handles the file upload and initiates the compression process. */
        const startCompression = async (file) => {
            if (isProcessing) return;
            isProcessing = true;
            setUIMode('processing');
            // Clear and reset results section
            resultsSection.innerHTML = '<h3 class="text-xl font-semibold text-center text-teal-400">3. Optimization Complete!</h3><p class="text-center text-gray-400">Your optimized segments are ready for download.</p>'; 

            if (file.type.startsWith('image/')) {
                 showStatusMessage('Image detected! Performing fast client-side optimization.', 'info');
                 await processImageClientSide(file);
                 isProcessing = false;
                 return;
            } else if (!file.type.startsWith('video/')) {
                showStatusMessage('Unsupported file type. Please upload a video or image file.', 'error');
                setUIMode('upload');
                isProcessing = false;
                return;
            }

            // --- Video Processing (Server-Side via Cloud Run API) ---
            const formData = new FormData();
            formData.append('file', file);
            updateProgress(0, `Uploading ${file.name} (${formatFileSize(file.size)})...`);

            try {
                // 1. UPLOAD STAGE
                const uploadResponse = await fetch(`${OPTIMIZER_API_URL}/upload`, { method: 'POST', body: formData });
                if (!uploadResponse.ok) { throw new Error(`Upload failed with status ${uploadResponse.status}. Server response may be unavailable.`); }
                const uploadData = await uploadResponse.json();
                const fileId = uploadData.fileId;
                updateProgress(20, `File uploaded. Starting server-side FFmpeg compression...`);

                // 2. PROCESS STAGE
                const processResponse = await fetch(`${OPTIMIZER_API_URL}/process`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fileId: fileId })
                });
                if (!processResponse.ok) { throw new Error(`Processing failed with status ${processResponse.status}.`); }
                const processData = await processResponse.json();
                const jobId = processData.jobId;
                updateProgress(40, `Compression job started (ID: ${jobId}). Waiting for results...`);

                // 3. POLLING STAGE (Wait for job to complete)
                let jobComplete = false;
                let finalResult = null;
                const pollInterval = 3000;
                let attempts = 0;
                while (!jobComplete && attempts < 100) { 
                    attempts++;
                    await new Promise(resolve => setTimeout(resolve, pollInterval));
                    const statusResponse = await fetch(`${OPTIMIZER_API_URL}/status?jobId=${jobId}`);
                    
                    if (!statusResponse.ok) {
                         console.error("Status check failed. Retrying...");
                         updateProgress(40 + (attempts * 0.5), `Server Status Check Failed (Attempt ${attempts}). Retrying...`);
                         continue;
                    }
                    const statusData = await statusResponse.json();
                    
                    if (statusData.status === 'completed') {
                        jobComplete = true;
                        finalResult = statusData;
                    } else if (statusData.status === 'failed') {
                        throw new Error(`Video processing failed on the server. Details: ${statusData.error}`);
                    } else {
                        const progress = 40 + (attempts * 0.5); 
                        updateProgress(progress, `Optimization in progress... (Attempt ${attempts})`);
                    }
                }
                
                if (!finalResult) { throw new Error("Job timed out. The server took too long to respond."); }
                updateProgress(100, 'All segments successfully optimized!');
                
                // 4. DISPLAY RESULTS
                if (finalResult.segments && finalResult.segments.length > 0) {
                    showStatusMessage(`Success! Video split into ${finalResult.segments.length} optimized 30-second segments.`, 'info');
                    finalResult.segments.forEach(renderDownloadCard);
                    setUIMode('results');
                } else {
                    throw new Error("Server completed the job but returned no downloadable segments.");
                }

            } catch (error) {
                console.error("Compression Error:", error);
                showStatusMessage(error.message || "An unknown error occurred during compression. Please ensure the backend service is running.", 'error');
                setUIMode('upload');
            } finally {
                isProcessing = false;
            }
        };

        /** Processes images locally using the Canvas API for compression. */
        const processImageClientSide = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        try {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            ctx.drawImage(img, 0, 0, img.width, img.height);
                            
                            // Compress using JPEG at 80% quality
                            canvas.toBlob((blob) => {
                                if (!blob) {
                                    showStatusMessage("Could not compress image.", 'error');
                                    setUIMode('upload');
                                    return resolve();
                                }
                                
                                const originalSize = file.size;
                                const compressedSize = blob.size;
                                const compressedUrl = URL.createObjectURL(blob);
                                
                                setUIMode('results');
                                showStatusMessage(`Image optimization complete! Original Size: ${formatFileSize(originalSize)} | New Size: ${formatFileSize(compressedSize)}`, 'info');

                                const segment = {
                                    fileName: `optimized_${file.name.replace(/\.[^/.]+$/, "")}.jpg`,
                                    size: compressedSize,
                                    url: compressedUrl
                                };
                                renderDownloadCard(segment, 0);

                                resolve();
                            }, 'image/jpeg', 0.8);

                        } catch (e) {
                            showStatusMessage("Error processing image in browser.", 'error');
                            setUIMode('upload');
                            resolve(); // Resolve even on error to clear processing state
                        }
                    };
                    img.src = event.target.result;
                };
                reader.onerror = () => {
                    showStatusMessage("Error reading file.", 'error');
                    setUIMode('upload');
                    resolve();
                };
                reader.readAsDataURL(file);
            });
        };

        // --- AI Caption Generator Logic ---

        /** Generates captions using the Gemini API. */
        const generateAICaptions = async () => {
            if (isGeneratingAI) return;
            const userPrompt = aiPromptInput.value.trim();
            if (!userPrompt) {
                showStatusMessage("Please describe your video/image content before generating captions.", 'error');
                return;
            }

            isGeneratingAI = true;
            aiResultsContainer.innerHTML = '';
            captionSpinner.classList.remove('hidden');
            magicWandIcon.classList.add('hidden');
            generateCaptionButton.disabled = true;

            const systemPrompt = "You are a creative social media manager specializing in short, viral video captions. Your task is to generate three unique, catchy, and status-ready captions based on the user's content description. Each caption must be distinct and ready to be used on platforms like WhatsApp or Instagram Stories. Format your final output as a numbered list.";
            const userQuery = `Generate 3 captions for content described as: "${userPrompt}"`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let responseText = "Failed to generate captions.";
            
            try {
                // Using exponential backoff for robustness
                for (let i = 0; i < 3; i++) { // Max 3 retries
                    const response = await fetch(GEMINI_API_URL + API_KEY, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        responseText = result.candidates?.[0]?.content?.parts?.[0]?.text || "No response received from AI model.";
                        break; // Success
                    } else if (i < 2) {
                        // Retry with exponential backoff
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    } else {
                        throw new Error(`API call failed with status ${response.status}`);
                    }
                }
            } catch (error) {
                console.error("Gemini API Error:", error);
                responseText = "Sorry, the AI caption generator failed to connect or process your request. Please try again later.";
            } finally {
                captionSpinner.classList.add('hidden');
                magicWandIcon.classList.remove('hidden');
                generateCaptionButton.disabled = false;
                isGeneratingAI = false;
            }

            // Display results
            const captions = responseText.split('\n').filter(line => line.trim().length > 0);
            
            if (captions.length > 0) {
                captions.forEach((caption, index) => {
                    const captionDiv = document.createElement('div');
                    captionDiv.classList.add('ai-result-card', 'p-3', 'rounded-lg', 'text-gray-200', 'text-sm', 'break-words', 'flex', 'items-center', 'justify-between');
                    
                    // Remove leading numbering/bullets if present
                    const cleanCaption = caption.replace(/^\d+\.\s*/, '').replace(/^-\s*/, '').trim();

                    captionDiv.innerHTML = `
                        <span class="mr-2 font-bold text-cyan-400">${index + 1}.</span>
                        <span class="flex-grow">${cleanCaption}</span>
                        <button class="copy-btn ml-3 p-1 rounded-md bg-pink-600 hover:bg-pink-500 transition duration-200" title="Copy">
                            <i data-lucide="copy" class="w-4 h-4 text-white"></i>
                        </button>
                    `;
                    aiResultsContainer.appendChild(captionDiv);
                });
                lucide.createIcons();
                
                // Attach copy functionality
                document.querySelectorAll('.copy-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const captionText = e.currentTarget.previousElementSibling.textContent.trim();
                        // Use execCommand for broader compatibility in iframes
                        const textarea = document.createElement('textarea');
                        textarea.value = captionText;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);

                        e.currentTarget.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-white"></i>';
                        e.currentTarget.classList.remove('bg-pink-600');
                        e.currentTarget.classList.add('bg-green-600');
                        lucide.createIcons();

                        setTimeout(() => {
                            e.currentTarget.innerHTML = '<i data-lucide="copy" class="w-4 h-4 text-white"></i>';
                            e.currentTarget.classList.remove('bg-green-600');
                            e.currentTarget.classList.add('bg-pink-600');
                            lucide.createIcons();
                        }, 2000);
                    });
                });
            } else {
                 // Display failure message
                const failDiv = document.createElement('div');
                failDiv.classList.add('error-message', 'p-3', 'rounded-lg', 'text-center');
                failDiv.textContent = responseText;
                aiResultsContainer.appendChild(failDiv);
            }
        };


        // --- Event Listeners ---
        fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) { startCompression(e.target.files[0]); } });

        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('drag-over'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) { startCompression(e.dataTransfer.files[0]); }
        });

        dropZone.addEventListener('click', () => { if (!isProcessing) { fileInput.click(); } });
        
        generateCaptionButton.addEventListener('click', generateAICaptions);

        // Initial setup
        setUIMode('upload');
    </script>
</body>
</html>
